# æ‹è³£æœå‹™ (Auction Service)

ä¼æ¥­äº¤æ˜“å¹³å°çš„æ‹è³£æœå‹™ï¼Œå¯¦æ–½å¯†å°æŠ•æ¨™æ‹è³£ç³»çµ±ï¼Œæ”¯æ´è»Ÿé—œé–‰æ©Ÿåˆ¶ã€é»‘åå–®ç®¡ç†ã€å³æ™‚é€šçŸ¥ç­‰åŠŸèƒ½ã€‚

## ğŸš€ åŠŸèƒ½ç‰¹è‰²

### Phase 1 - æ ¸å¿ƒæ‹è³£åŠŸèƒ½ (å·²å¯¦æ–½)
- âœ… å¯†å°æŠ•æ¨™æ‹è³£ç³»çµ±
- âœ… è»Ÿé—œé–‰æ©Ÿåˆ¶ (anti-sniping)
- âœ… åƒ¹æ ¼å€é–“é©—è­‰
- âœ… é»‘åå–®ç®¡ç†
- âœ… åŒ¿ååŒ–å‡ºåƒ¹è€…é¡¯ç¤º
- âœ… æ‹è³£çµæŸè‡ªå‹•æ’å
- âœ… é€šçŸ¥ç³»çµ± (å‰7å + å…¶ä»–åƒèˆ‡è€…)
- âœ… å¯©è¨ˆæ—¥èªŒè¿½è¹¤

### æ‹è³£è¦å‰‡
- **æ‹è³£é¡å‹**ï¼šå¯†å°æŠ•æ¨™ï¼ˆç›²æ¨™ï¼‰
- **æ‹è³£æœŸé–“**ï¼š1-61å¤©
- **åƒ¹æ ¼æ©Ÿåˆ¶**ï¼šæ¥­ä¸»è¨­å®šåƒ¹æ ¼å€é–“ï¼ŒæŠ•æ¨™è€…åªèƒ½åœ¨å€é–“å…§å‡ºåƒ¹
- **è»Ÿé—œé–‰**ï¼šçµæŸå‰3åˆ†é˜è‹¥æœ‰äººå‡ºåƒ¹ï¼Œè‡ªå‹•å»¶é•·1åˆ†é˜
- **åŒ¿ååŒ–**ï¼šé¡¯ç¤ºç‚º "Bidder #23" ç­‰åŒ¿åæ¨™ç±¤
- **é»‘åå–®**ï¼šå·¥ä½œäººå“¡æ‰‹å‹•ç®¡ç†ï¼Œé˜»æ­¢æƒ¡æ„ç”¨æˆ¶åƒèˆ‡

## ğŸ—ï¸ æŠ€è¡“æ¶æ§‹

- **èªè¨€**: Go 1.23
- **æ¡†æ¶**: Gin Web Framework
- **è³‡æ–™åº«**: MySQL 8.0 + GORM
- **å¿«å–**: Redis (é ç•™)
- **èªè­‰**: JWT
- **æ—¥èªŒ**: Zap çµæ§‹åŒ–æ—¥èªŒ
- **éƒ¨ç½²**: Docker + Google Cloud Run

## ğŸ“¦ å®‰è£èˆ‡åŸ·è¡Œ

### æœ¬åœ°é–‹ç™¼

```bash
# 1. è¤‡è£½ç’°å¢ƒè®Šæ•¸
cp env.example .env
# ç·¨è¼¯ .env è¨­å®šè³‡æ–™åº«é€£ç·šç­‰è³‡è¨Š

# 2. å•Ÿå‹•è³‡æ–™åº« (ä½¿ç”¨ Docker Compose)
docker-compose -f docker-compose.dev.yml up -d mysql redis

# 3. åŸ·è¡Œ migrations
make migrate

# 4. å•Ÿå‹•æœå‹™
make run
```

### Docker é–‹ç™¼ç’°å¢ƒ

```bash
# å•Ÿå‹•å®Œæ•´é–‹ç™¼ç’°å¢ƒ (åŒ…å«ç†±é‡è¼‰)
docker-compose -f docker-compose.dev.yml up --build

# æŸ¥çœ‹æ—¥èªŒ
docker-compose -f docker-compose.dev.yml logs -f auction-service

# åœæ­¢æœå‹™
docker-compose -f docker-compose.dev.yml down
```

### ç”Ÿç”¢ç’°å¢ƒ

```bash
# å•Ÿå‹•ç”Ÿç”¢ç’°å¢ƒ
docker-compose up --build -d

# åŸ·è¡Œ finalize-job (å®šæ™‚ä»»å‹™)
docker-compose run --rm finalize-job
```

## ğŸ“š API æ–‡ä»¶

### èªè­‰
æ‰€æœ‰éœ€è¦èªè­‰çš„ API éƒ½éœ€è¦åœ¨ Header ä¸­åŒ…å«ï¼š
```
Authorization: Bearer <JWT_TOKEN>
```

### æ‹è³£ç®¡ç†
- `POST /api/v1/auctions` - å‰µå»ºæ‹è³£ (è³£å®¶)
- `POST /api/v1/auctions/:id:activate` - å•Ÿç”¨æ‹è³£ (è³£å®¶)
- `POST /api/v1/auctions/:id:cancel` - å–æ¶ˆæ‹è³£ (è³£å®¶/ç®¡ç†å“¡)
- `GET /api/v1/auctions` - æ‹è³£åˆ—è¡¨ (å…¬é–‹)
- `GET /api/v1/auctions/:id` - æ‹è³£è©³æƒ… (å…¬é–‹)

### å‡ºåƒ¹
- `POST /api/v1/auctions/:id/bids` - æäº¤å‡ºåƒ¹ (è²·å®¶)
- `GET /api/v1/auctions/:id/my-bids` - æŸ¥çœ‹æˆ‘çš„å‡ºåƒ¹ (è²·å®¶)
- `GET /api/v1/auctions/:id/results` - æ‹è³£çµæœ (å‰7å/è³£å®¶)
- `GET /api/v1/auctions/:id/stats/histogram` - å‡ºåƒ¹åˆ†ä½ˆåœ–

### ç®¡ç†åŠŸèƒ½
- `GET /api/v1/admin/blacklist` - é»‘åå–®åˆ—è¡¨ (ç®¡ç†å“¡)
- `POST /api/v1/admin/blacklist` - æ–°å¢é»‘åå–® (ç®¡ç†å“¡)
- `DELETE /api/v1/admin/blacklist/:user_id` - ç§»é™¤é»‘åå–® (ç®¡ç†å“¡)

### WebSocket å³æ™‚åŠŸèƒ½
- `WS /ws/auctions/:auction_id` - æ‹è³£æˆ¿é–“ WebSocket é€£æ¥
- `GET /ws/stats` - WebSocket é€£æ¥çµ±è¨ˆ

#### WebSocket è¨Šæ¯é¡å‹
- `hello` - æ­¡è¿è¨Šæ¯ (é€£æ¥å»ºç«‹æ™‚)
- `state` - æ‹è³£ç‹€æ…‹è®Šæ›´ (å•Ÿç”¨/å–æ¶ˆ)
- `bid_accepted` - å‡ºåƒ¹æˆåŠŸ (å³æ™‚å»£æ’­)
- `extended` - è»Ÿé—œé–‰å»¶é•· (å³æ™‚å»£æ’­)
- `closed` - æ‹è³£çµæŸ/å–æ¶ˆ
- `resume_ok` - æ–·ç·šæ¢å¾©ç¢ºèª
- `error` - éŒ¯èª¤è¨Šæ¯

## ğŸ—ƒï¸ è³‡æ–™åº«çµæ§‹

### æ ¸å¿ƒè¡¨æ ¼
- `auctions` - æ‹è³£ä¸»è¡¨
- `bids` - å‡ºåƒ¹è¨˜éŒ„
- `auction_status_ref` - æ‹è³£ç‹€æ…‹åƒè€ƒ
- `auction_status_history` - ç‹€æ…‹è®Šæ›´æ­·å²
- `auction_events` - æ‹è³£äº‹ä»¶è¨˜éŒ„

### åŠŸèƒ½è¡¨æ ¼
- `user_blacklist` - é»‘åå–®
- `auction_bidder_aliases` - åŒ¿ååˆ¥åæ˜ å°„
- `auction_bid_histograms` - å‡ºåƒ¹åˆ†ä½ˆå¿«ç…§
- `auction_notification_log` - é€šçŸ¥è¨˜éŒ„
- `audit_logs` - å¯©è¨ˆæ—¥èªŒ

## ğŸ”§ é–‹ç™¼å‘½ä»¤

```bash
# ç·¨è­¯
make build

# åŸ·è¡Œ
make run

# æ¸…ç†
make clean

# ä¾è³´ç®¡ç†
make tidy

# è³‡æ–™åº«é·ç§»
make migrate        # åŸ·è¡Œé·ç§»
make migrate-down   # å›æ»¾é·ç§»
make migrate-status # æª¢æŸ¥é·ç§»ç‹€æ…‹

# åŸ·è¡ŒçµæŸä½œæ¥­
make finalize-job

# æ¸¬è©¦
make test
make test-coverage
```

## ğŸš¢ éƒ¨ç½²

### Google Cloud Run

```bash
# è¨­å®šå°ˆæ¡ˆ ID
export GOOGLE_CLOUD_PROJECT=your-project-id

# éƒ¨ç½²
./deploy.sh

# æˆ–æŒ‡å®šæ¨™ç±¤
./deploy.sh v1.0.0
```

### ç’°å¢ƒè®Šæ•¸è¨­å®š

ç”Ÿç”¢ç’°å¢ƒéœ€è¦åœ¨ Google Cloud Console è¨­å®šä»¥ä¸‹ Secretï¼š
- `auction-db-config` (host, user, password, database)
- `auction-redis-config` (host)
- `auction-jwt-config` (secret)

## ğŸ“Š ç›£æ§èˆ‡æ—¥èªŒ

### å¥åº·æª¢æŸ¥
- `GET /healthz` - ç°¡å–®å¥åº·æª¢æŸ¥
- `GET /health` - è©³ç´°å¥åº·ç‹€æ…‹

### æ—¥èªŒæ ¼å¼
ä½¿ç”¨ Zap çµæ§‹åŒ–æ—¥èªŒï¼ŒåŒ…å«ï¼š
- Request ID è¿½è¹¤
- ç”¨æˆ¶æ“ä½œå¯©è¨ˆ
- éŒ¯èª¤å †ç–Šè¿½è¹¤
- æ€§èƒ½æŒ‡æ¨™

## ğŸ”’ å®‰å…¨è€ƒé‡

- JWT Token é©—è­‰
- SQL æ³¨å…¥é˜²è­· (åƒæ•¸åŒ–æŸ¥è©¢)
- å‡ºåƒ¹é »ç‡é™åˆ¶ (5ç§’/æ¬¡)
- é»‘åå–®æ©Ÿåˆ¶
- æ•æ„Ÿè³‡æ–™é›œæ¹Šè™•ç†
- CORS é…ç½®

## ğŸ“ˆ æ€§èƒ½å„ªåŒ–

- è³‡æ–™åº«ç´¢å¼•å„ªåŒ–
- é€£ç·šæ± ç®¡ç†
- è»Ÿé—œé–‰äº‹å‹™é–å®š
- å¯©è¨ˆæ—¥èªŒç•°æ­¥å¯«å…¥

## ğŸ§ª æ¸¬è©¦

ç›®å‰å°šæœªå¯¦æ–½æ¸¬è©¦ï¼Œå»ºè­°å¾ŒçºŒåŠ å…¥ï¼š
- å–®å…ƒæ¸¬è©¦ (æ¥­å‹™é‚è¼¯)
- æ•´åˆæ¸¬è©¦ (API ç«¯é»)
- å£“åŠ›æ¸¬è©¦ (ä½µç™¼å‡ºåƒ¹)

## ğŸ“‹ å¾…è¾¦äº‹é …

### Phase 2 - WebSocket å³æ™‚åŠŸèƒ½ (å·²å¯¦æ–½)
- âœ… WebSocket é€£ç·šç®¡ç†
- âœ… å³æ™‚å‡ºåƒ¹å»£æ’­
- âœ… æ–·ç·šé‡é€£æ©Ÿåˆ¶
- âœ… è»Ÿé—œé–‰å»¶é•·æ¨é€
- âœ… é™ç´šæ§åˆ¶æ©Ÿåˆ¶
- âœ… å¿ƒè·³å’Œé€£ç·šç›£æ§

### Phase 3 - é¢¨æ§èˆ‡å„ªåŒ–
- [ ] å¤šå±¤å¿«å–ç­–ç•¥
- [ ] é™ç´šæ©Ÿåˆ¶
- [ ] ç•°å¸¸åµæ¸¬
- [ ] ç›£æ§å‘Šè­¦

## ğŸ“ æ”¯æ´

å¦‚æœ‰å•é¡Œè«‹è¯ç¹«é–‹ç™¼åœ˜éšŠæˆ–æŸ¥çœ‹ç›¸é—œæ–‡æª”ã€‚